#!/usr/bin/env python3
"""–¢–µ—Å—Ç –º–∞—Ç—á–∏–Ω–≥–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –≠–ª—å—Ñ

–°–∏–º—É–ª–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Ç–æ–≤–∞—Ä–æ–≤ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –º–∞—Ç—á–∏–Ω–≥.
"""

import sys

sys.path.insert(0, ".")

from uuid import UUID
from backend.models.database import get_supabase_client
from backend.services.matching import MatchingService

# –¢–æ–≤–∞—Ä—ã –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –≠–ª—å—Ñ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
TEST_ITEMS = """
–¢—Ä—É–±–∞ –ü–ü (1,5 –º–º) 50—Ö0.15  —à—Ç  730
–¢—Ä—É–±–∞ –ü–ü (1,5 –º–º) 50—Ö0.25  —à—Ç  1 400
–¢—Ä—É–±–∞ –ü–ü (1,5 –º–º) 50—Ö0.5  —à—Ç  2 000
–¢—Ä—É–±–∞ –ü–ü (1,5 –º–º) 50—Ö0.75  —à—Ç  300
–¢—Ä—É–±–∞ –ü–ü (1,5 –º–º) 50—Ö1.0  —à—Ç  1 650
–¢—Ä—É–±–∞ –ü–ü (1,5 –º–º) 50—Ö1.5  —à—Ç  820
–¢—Ä—É–±–∞ –ü–ü (1,5 –º–º) 50—Ö2.0  —à—Ç  1 720
–¢—Ä—É–±–∞ –ü–ü (1,5 –º–º) 50—Ö3.0  —à—Ç  330
–¢—Ä—É–±–∞ –ü–ü (2,2 –º–º) 110—Ö0.15  —à—Ç  270
–¢—Ä—É–±–∞ –ü–ü (2,2 –º–º) 110—Ö0.25  —à—Ç  800
–¢—Ä—É–±–∞ –ü–ü (2,2 –º–º) 110—Ö0.5  —à—Ç  900
–¢—Ä—É–±–∞ –ü–ü (2,2 –º–º) 110—Ö0.75  —à—Ç  150
–¢—Ä—É–±–∞ –ü–ü (2,2 –º–º) 110—Ö1.0  —à—Ç  1 300
–¢—Ä—É–±–∞ –ü–ü (2,2 –º–º) 110—Ö1.5  —à—Ç  500
–¢—Ä—É–±–∞ –ü–ü (2,2 –º–º) 110—Ö2.0  —à—Ç  1 050
–¢—Ä—É–±–∞ –ü–ü (2,2 –º–º) 110—Ö3.0  —à—Ç  400
–¢—Ä—É–±–∞ –ü–ü 32*1.0 (1,8 –º–º)  —à—Ç  100
–¢—Ä—É–±–∞ –ü–ü 32*2.0 (1,8 –º–º)  —à—Ç  20
–¢—Ä—É–±–∞ –ü–ü 40*0.25 (1,8 –º–º)  —à—Ç  120
–¢—Ä—É–±–∞ –ü–ü 40*0.5 (1,8 –º–º)  —à—Ç  60
–¢—Ä—É–±–∞ –ü–ü 40*1.0 (1,8 –º–º)  —à—Ç  120
–ê—ç—Ä–∞—Ç–æ—Ä –ü–ü 110  —à—Ç  90
–ê—ç—Ä–∞—Ç–æ—Ä –ü–ü 50  —à—Ç  80
–ó–∞–≥–ª—É—à–∫–∞ –ü–ü 40  —à—Ç  100
–ó–∞–≥–ª—É—à–∫–∞ –ü–ü 50  —à—Ç  1 550
–ó–∞–≥–ª—É—à–∫–∞ –ü–ü 110  —à—Ç  760
–ó–æ–Ω—Ç –ü–ü 50  —à—Ç  70
–ó–æ–Ω—Ç –ü–ü 110  —à—Ç  240
–ö–ª–∞–ø–∞–Ω –æ–±—Ä–∞—Ç–Ω—ã–π 110 –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π  —à—Ç  10
–ö—Ä–µ—Å—Ç–æ–≤–∏–Ω–∞ –ü–ü 50—Ö50—Ö50 45¬∞  —à—Ç  20
–ö—Ä–µ—Å—Ç–æ–≤–∏–Ω–∞ –ü–ü 110—Ö50—Ö50 90¬∞  —à—Ç  45
–ú—É—Ñ—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å —Ä–∞—Å—Ç—Ä—É–±–∞ 110  —à—Ç  140
–ú—É—Ñ—Ç–∞ –ü–ü 50  —à—Ç  300
–ú—É—Ñ—Ç–∞ –ü–ü 50 (—Ä–µ–º–æ–Ω—Ç)  —à—Ç  200
–ú—É—Ñ—Ç–∞ –ü–ü 110  —à—Ç  400
–ú—É—Ñ—Ç–∞ –ü–ü 110 (—Ä–µ–º–æ–Ω—Ç)  —à—Ç  700
–û—Ç–≤–æ–¥ –ü–ü 32 45¬∞  —à—Ç  50
–û—Ç–≤–æ–¥ –ü–ü 40 45¬∞  —à—Ç  250
–û—Ç–≤–æ–¥ –ü–ü 40 87¬∞  —à—Ç  300
–û—Ç–≤–æ–¥ –ü–ü 50 45¬∞  —à—Ç  2 300
–û—Ç–≤–æ–¥ –ü–ü 50 90¬∞  —à—Ç  2 310
–û—Ç–≤–æ–¥ –ü–ü 110 45¬∞  —à—Ç  1 300
–û—Ç–≤–æ–¥ –ü–ü 110 90¬∞  —à—Ç  1 700
–ü–∞—Ç—Ä—É–±–æ–∫ –∫–æ–º–ø. –ü–ü 110  —à—Ç  300
–ü–µ—Ä–µ—Ö–æ–¥ –ü–ü 40*32  —à—Ç  20
–ü–µ—Ä–µ—Ö–æ–¥ –ü–ü 50*32  —à—Ç  60
–ü–µ—Ä–µ—Ö–æ–¥ –ü–ü 110—Ö50  —à—Ç  440
–ü–µ—Ä–µ—Ö–æ–¥ –ü–ü 110—Ö50 –∫–æ—Ä–æ—Ç–∫–∏–π  —à—Ç  300
–ü–µ—Ä–µ—Ö–æ–¥ —Å–æ–æ—Å–Ω—ã–π –ü–ü 110—Ö124 —Å –º–∞–Ω–∂–µ—Ç–æ–π  —à—Ç  270
–ö—Ä–µ—Å—Ç–æ–≤–∏–Ω–∞ –ü–ü 110—Ö110—Ö50 45¬∞  —à—Ç  20
–†–µ–≤–∏–∑–∏—è –ü–ü 110  —à—Ç  100
–¢—Ä–∞–ø –ü–ü 110 150—Ö150 –≤–µ—Ä—Ç  —à—Ç  10
–¢—Ä–∞–ø –ª–∏–Ω–µ–π–Ω—ã–π –¥/–¥—É—à–∞ –ø/–ø–ª–∏—Ç–∫—É 40 —Å–º 50 Jakko 360¬∞ —Å–∏—Ñ–æ–Ω–æ–º –∏ —Å—É—Ö–∏–º –∑–∞—Ç–≤–æ—Ä–æ–º  —à—Ç  5
–¢—Ä–æ–π–Ω–∏–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å —Ä–∞—Å—Ç—Ä—É–±–∞ 110*110*96  —à—Ç  5
–¢—Ä–æ–π–Ω–∏–∫ –ü–ü 40—Ö40—Ö45¬∞  —à—Ç  100
–¢—Ä–æ–π–Ω–∏–∫ –ü–ü 50*32—Ö87¬∞  —à—Ç  40
–¢—Ä–æ–π–Ω–∏–∫ –ü–ü 50*40—Ö87¬∞  —à—Ç  100
–¢—Ä–æ–π–Ω–∏–∫ –ü–ü 50—Ö40—Ö45¬∞  —à—Ç  100
–¢—Ä–æ–π–Ω–∏–∫ –ü–ü 50—Ö50—Ö45¬∞  —à—Ç  1 500
–¢—Ä–æ–π–Ω–∏–∫ –ü–ü 50—Ö50—Ö90¬∞  —à—Ç  1 300
–¢—Ä–æ–π–Ω–∏–∫ –ü–ü 110—Ö50 90¬∞  —à—Ç  200
–¢—Ä–æ–π–Ω–∏–∫ –ü–ü 110—Ö110—Ö45  —à—Ç  250
–¢—Ä–æ–π–Ω–∏–∫ –ü–ü 110—Ö110—Ö90  —à—Ç  900
–•–æ–º—É—Ç –ü–ü 50  —à—Ç  1 000
–•–æ–º—É—Ç –ü–ü 110  —à—Ç  50
–ó–∞–≥–ª—É—à–∫–∞ –†–† –ù–ê–†–£–ñ–ù–ê–Ø 110  —à—Ç  170
–ö–ª–∞–ø–∞–Ω –æ–±—Ä–∞—Ç–Ω—ã–π –†–† –ù–ê–†–£–ñ–ù–ê–Ø 110  —à—Ç  10
–ú—É—Ñ—Ç–∞ —Ä–µ–º–æ–Ω—Ç–Ω–∞—è –†–† –ù–ê–†–£–ñ–ù–ê–Ø 110  —à—Ç  115
–ú—É—Ñ—Ç–∞ —Ä–µ–º–æ–Ω—Ç–Ω–∞—è –†–† –ù–ê–†–£–ñ–ù–ê–Ø 160  —à—Ç  60
–û—Ç–≤–æ–¥ –†–† –ù–ê–†–£–ñ–ù–ê–Ø 110—Ö30  —à—Ç  30
–û—Ç–≤–æ–¥ –†–† –ù–ê–†–£–ñ–ù–ê–Ø 110—Ö45  —à—Ç  650
–û—Ç–≤–æ–¥ –†–† –ù–ê–†–£–ñ–ù–ê–Ø 110—Ö67  —à—Ç  30
–û—Ç–≤–æ–¥ –†–† –ù–ê–†–£–ñ–ù–ê–Ø 110—Ö90  —à—Ç  130
–û—Ç–≤–æ–¥ –†–† –ù–ê–†–£–ñ–ù–ê–Ø 160—Ö45  —à—Ç  30
–û—Ç–≤–æ–¥ –†–† –ù–ê–†–£–ñ–ù–ê–Ø 160—Ö90  —à—Ç  30
–û—Ç–≤–æ–¥ –†–† –ù–ê–†–£–ñ–ù–ê–Ø 200—Ö90  —à—Ç  10
–ü–µ—Ä–µ—Ö–æ–¥ –†–† –ù–ê–†–£–ñ–ù–ê–Ø 160—Ö110  —à—Ç  120
–†–µ–≤–∏–∑–∏—è —Å –∫—Ä—ã—à–∫–æ–π –†–† –ù–ê–†–£–ñ–ù–ê–Ø 110  —à—Ç  80
–¢—Ä–æ–π–Ω–∏–∫ –†–† –ù–ê–†–£–ñ–ù–ê–Ø 110—Ö110—Ö45  —à—Ç  250
–¢—Ä–æ–π–Ω–∏–∫ –†–† –ù–ê–†–£–ñ–ù–ê–Ø 160—Ö110—Ö90  —à—Ç  15
–¢—Ä–æ–π–Ω–∏–∫ –†–† –ù–ê–†–£–ñ–ù–ê–Ø 160—Ö160—Ö90  —à—Ç  10
""".strip()


def parse_items(text: str) -> list[tuple[str, int]]:
    """–ü–∞—Ä—Å–∏—Ç —Ç–æ–≤–∞—Ä—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞: –Ω–∞–∑–≤–∞–Ω–∏–µ + –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"""
    items = []
    for line in text.strip().split("\n"):
        line = line.strip()
        if not line:
            continue

        # –§–æ—Ä–º–∞—Ç: "–ù–∞–∑–≤–∞–Ω–∏–µ  —à—Ç  –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"
        parts = line.rsplit("  ", 2)  # Split from right by double spaces
        if len(parts) >= 2:
            name = parts[0].strip()
            qty_str = parts[-1].replace(" ", "").strip()
            try:
                qty = int(qty_str)
            except ValueError:
                qty = 1
            items.append((name, qty))

    return items


def main():
    db = get_supabase_client()

    # –ü–æ–ª—É—á–∏—Ç—å client_id –¥–ª—è –≠–ª—å—Ñ
    client_resp = db.table("clients").select("id").eq("code", "ELF").execute()
    if not client_resp.data:
        print("–û–®–ò–ë–ö–ê: –ö–ª–∏–µ–Ω—Ç –≠–ª—å—Ñ –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return

    client_id = UUID(client_resp.data[0]["id"])
    print(f"Client ID: {client_id}")

    # –ü–∞—Ä—Å–∏–º —Ç–æ–≤–∞—Ä—ã
    items = parse_items(TEST_ITEMS)
    print(f"–¢–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∞: {len(items)}")
    print("=" * 80)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º matcher
    matcher = MatchingService()

    matched = []
    not_found = []

    for name, qty in items:
        # –ò—â–µ–º –º–∞—Ç—á –∏—Å–ø–æ–ª—å–∑—É—è –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–∫ SKU (—ç—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç –≠–ª—å—Ñ)
        result = matcher.match_item(
            client_id=client_id, client_sku=name, client_name=name
        )

        if result.product_id:
            matched.append(
                {
                    "input": name,
                    "qty": qty,
                    "product_name": result.product_name,
                    "confidence": result.confidence,
                    "match_type": result.match_type,
                }
            )
        else:
            not_found.append(
                {"input": name, "qty": qty, "match_type": result.match_type}
            )

    # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
    print("\n" + "=" * 80)
    print("–†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø")
    print("=" * 80)

    print(
        f"\n‚úÖ –ù–ê–ô–î–ï–ù–û: {len(matched)} –∏–∑ {len(items)} ({100*len(matched)/len(items):.1f}%)"
    )

    if matched:
        print("\n–£—Å–ø–µ—à–Ω—ã–µ –º–∞—Ç—á–∏:")
        for m in matched[:30]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 30
            print(
                f"  [{m['match_type']}] {m['confidence']:.0f}% | {m['input'][:50]} ‚Üí {m['product_name'][:50]}"
            )
        if len(matched) > 30:
            print(f"  ... –∏ –µ—â—ë {len(matched) - 30} —É—Å–ø–µ—à–Ω—ã—Ö –º–∞—Ç—á–µ–π")

    if not_found:
        print(f"\n‚ùå –ù–ï –ù–ê–ô–î–ï–ù–û: {len(not_found)}")
        for nf in not_found:
            print(f"  - {nf['input']}")

    print("\n" + "=" * 80)
    success_rate = 100 * len(matched) / len(items) if items else 0
    if success_rate == 100:
        print("üéâ 100% –£–°–ü–ï–•!")
    else:
        print(f"‚ö†Ô∏è  –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: {success_rate:.1f}%")


if __name__ == "__main__":
    main()
