import re
import unicodedata

# Синонимы материалов - приводим к полной форме
MATERIAL_SYNONYMS = {
    'пп': 'полипропилен',
    'pp': 'полипропилен',
    'пэ': 'полиэтилен',
    'pe': 'полиэтилен',
    'пвх': 'поливинилхлорид',
    'pvc': 'поливинилхлорид',
    'ппр': 'полипропилен',
    'ppr': 'полипропилен',
    'pert': 'полиэтилен',
    'pe-rt': 'полиэтилен',
    # ПНД = компрессионные фитинги (каталог: "Тройник компрессионный 20")
    'пнд': 'компрессионный',
    'hdpe': 'компрессионный',
}

# Синонимы типов товаров
PRODUCT_SYNONYMS = {
    # Типы фитингов
    'колено': 'отвод',
    'угол': 'отвод',
    'угольник': 'отвод',
    'elbow': 'отвод',
    'тройник': 'тройник',
    'тройничок': 'тройник',
    'трой': 'тройник',
    'tee': 'тройник',
    'муфта': 'муфта',
    'муфточка': 'муфта',
    'coupling': 'муфта',
    'заглушка': 'заглушка',
    'заглуха': 'заглушка',
    'cap': 'заглушка',
    'plug': 'заглушка',
    'крест': 'крестовина',
    'крестовик': 'крестовина',
    'редукция': 'переходник',
    # Канализация
    'канализ': 'канализационн',
    'кан': 'канализационн',
    'нар кан': 'наружная канализация',
    'нар.кан': 'наружная канализация',
    'оранжевая': 'наружная канализация',
    'рыжая': 'наружная канализация',
    'малошум': 'малошумная',
    'белая кан': 'prestige',
    # Резьба: сокращения клиентов
    'вн рез': 'внутренняя резьба',
    'вн.рез': 'внутренняя резьба',
    'нар рез': 'наружная резьба',
    'нар.рез': 'наружная резьба',
    'в р': 'внутренняя резьба',
    'в/р': 'внутренняя резьба',
    'н р': 'наружная резьба',
    'н/р': 'наружная резьба',
    'нр': 'нр',  # НР = наружная резьба (короткая форма для ВН/НР)
    'вр': 'вр',  # ВР = внутренняя резьба
    'вн': 'вн',  # ВН = внутренняя (для ВН/НР переходников)
    'пн': 'вн',  # ПН = опечатка ВН (Переходник ПН/НР = ВН/НР)
    'мама': 'внутренняя резьба',  # сленг сантехников
    'папа': 'наружная резьба',  # сленг сантехников
    # Сокращения клиентов
    'ред': 'переходник',  # тройник ред. 40*25*40 = тройник переходник
    'арм': 'армированная',  # труба арм.
    'стекловолокно': 'стекловолокно',  # армирование
    'компенсирующая петля': 'компенсатор',  # синоним
    'штанга': '',  # убираем "(штанга 4 м)" - это просто длина
    # Резьбовые муфты (американки)
    'американка': 'разъемная',  # муфта американка = муфта разъемная
    'разъемн': 'разъемная',  # муфта разъемн. = муфта разъемная
    # Переходники
    'переходн': 'переходник',  # переходная/переходной муфта/тройник
    'переход': 'переходник',  # переход = переходник
    # Крепёж канализации - простой случай (слова рядом)
    'хомут с защелк': 'клипсы',  # хомут с защёлкой = клипсы кан.
    # Крепёж для труб (опора/держатель/стойка = клипса)
    'держатель': 'клипсы',
    'стойка': 'клипсы',
    'опора': 'клипсы',
    # ПНД фитинги
    'присоединительн': 'компрессионный',  # отвод присоединительный = отвод компрессионный
    'комп': 'компрессионный',  # комп. = компрессионный
    'компр': 'компрессионный',  # компр. = компрессионный
    'компрес': 'компрессионный',  # компрес. = компрессионный (каталог Jakko)
    'цанг': 'компрессионный',  # цанговые фитинги = компрессионные ПНД
    'зажимн': 'компрессионный',  # зажимные = компрессионные
    'соединительн': '',  # "комп.соед." → "компрессионный" (соед. убираем)
    'соед': '',  # убираем остатки "соед."
    # PN (давление)
    'pn20': 'pn 20',
    'pn-20': 'pn 20',
    'пн20': 'pn 20',
    'pn25': 'pn 25',
    'pn-25': 'pn 25',
    'пн25': 'pn 25',
}

# Таблица соответствия диаметров труб (мм) размерам хомутов (дюймы)
PIPE_MM_TO_INCH = {
    15: '3/8"', 16: '3/8"', 19: '3/8"',
    20: '1/2"', 25: '1/2"',
    26: '3/4"', 30: '3/4"',
    32: '1"', 36: '1"',
    40: '1 1/4"', 46: '1 1/4"',
    50: '1 1/2"', 51: '1 1/2"',
    63: '2"', 65: '2"',
    75: '2 1/2"', 78: '2 1/2"',
    90: '3"', 92: '3"',
    110: '4"', 115: '4"',
    140: '5"', 142: '5"',
    160: '6"', 166: '6"',
}

def expand_synonyms(text: str) -> str:
    """Заменяет сокращения материалов и типов на полные формы"""
    result = text.lower()
    # Заменяем материалы (как отдельные слова)
    for abbr, full in MATERIAL_SYNONYMS.items():
        result = re.sub(rf'\b{re.escape(abbr)}\b', full, result)
    # Заменяем типы товаров (сортируем по длине - длинные первые)
    sorted_synonyms = sorted(PRODUCT_SYNONYMS.items(), key=lambda x: len(x[0]), reverse=True)
    for abbr, full in sorted_synonyms:
        result = re.sub(rf'\b{re.escape(abbr)}\.?\b', full, result)
    return result


def normalize_sku(sku: str) -> str:
    """Нормализация артикула для сравнения"""
    if not sku:
        return ""
    # Приводим к верхнему регистру
    result = sku.upper()
    # Убираем пробелы, дефисы, точки, слэши
    result = re.sub(r'[\s\-\.\/_]+', '', result)
    # Убираем leading zeros
    result = result.lstrip('0') or '0'
    return result

def normalize_name(name: str) -> str:
    """Нормализация названия товара для fuzzy matching"""
    if not name:
        return ""
    # Приводим к нижнему регистру
    result = name.lower()
    # Нормализуем Unicode
    result = unicodedata.normalize('NFKC', result)
    # Заменяем ё на е
    result = result.replace('ё', 'е')
    # Расширяем синонимы материалов и типов
    result = expand_synonyms(result)
    # Нормализуем термины резьбы ДО обработки размеров
    # "с внутренней резьбой" → "с вн рез", "с наружной резьбой" → "с нар рез"
    result = re.sub(r'\bс?\s*внутр\w*\s*резьб\w*', 'с вн рез', result)
    result = re.sub(r'\bс?\s*наруж\w*\s*резьб\w*', 'с нар рез', result)
    # Хомут с защёлкой (размер может быть между словами) → клипсы
    # "хомут d50мм с защелк" → "клипсы 50"
    # "хомут 110 с защелк" → "клипсы 110"
    def convert_clamp_to_clip(m):
        size = m.group(1) or ''
        # Извлекаем только число из размера (d50мм → 50)
        size_num = re.search(r'(\d+)', size)
        if size_num:
            return f'клипсы {size_num.group(1)}'
        return 'клипсы'
    result = re.sub(r'\bхомут\s+([d\d]+\s*мм?|\d+)?\s*с\s+защелк\w*', convert_clamp_to_clip, result)
    # Убираем информацию об упаковке штук (уп 20 шт), (20 шт)
    # НО сохраняем метраж (50 м), (100 м) - это разные товары!
    result = re.sub(r'\(уп\.?\s*\d+\s*шт\.?\)', '', result)
    result = re.sub(r'\(\d+\s*шт\)', '', result)
    # Убираем толщину в скобках (2.7), (2.2), (1,8)
    result = re.sub(r'\(\d+[.,]\d+\)', '', result)
    # Убираем типы муфт/переходов для базового сопоставления
    result = re.sub(r'\(двухраструбная\)', '', result)
    # НО сохраняем "ремонтная" - это разные товары!
    result = re.sub(r'\(ремонтная\)', 'ремонтная', result)  # убираем скобки, слово оставляем
    result = re.sub(r'\bсоединительн\w*', '', result)  # соединительная/ый
    # Нормализуем переход/переходник
    result = re.sub(r'\bпереход\b', 'переходник', result)
    result = re.sub(r'\bэксц\.?\b', '', result)  # эксцентрический
    # Компенсатор кан. = Патрубок компенсационный
    result = re.sub(r'\bкомпенсатор\s+кан', 'патрубок компенсационный', result)
    # Хомут 110 → Хомут 4" (конвертация мм в дюймы)
    def convert_clamp_mm_to_inch(m):
        mm = int(m.group(1))
        inch = PIPE_MM_TO_INCH.get(mm, f'{mm}')
        return f'хомут в комплекте {inch}'
    result = re.sub(r'\bхомут\s+(\d+)\b', convert_clamp_mm_to_inch, result)
    # Убираем цвет - не важен для сопоставления
    result = re.sub(r'\bсер(?:ый|ая|ое|ые)\b', '', result)
    result = re.sub(r'\bбел(?:ый|ая|ое|ые)\b', '', result)
    # Убираем "мм" после чисел (25мм → 25)
    result = re.sub(r'(\d+)\s*мм\b', r'\1', result)
    # Убираем углы с "град/градус/гр" (90 град → 90)
    result = re.sub(r'\b(45|67|87|90)\s*(?:град(?:ус)?\.?|гр\.?)\b', r'\1', result, flags=re.IGNORECASE)
    # Формат СТ: "d40 L250мм" или "d50 (1,8) L150мм" → "40×250"
    def convert_st_pipe_format(m):
        diameter = m.group(1)
        length = m.group(2)
        return f'{diameter}×{length}'
    result = re.sub(r'd(\d+)[^lL]*l(\d+)\s*мм?', convert_st_pipe_format, result)
    # Нормализуем размеры труб: 110-2000, 110х50, 110*50, 110×50 → 110×50
    # Унифицируем разделители (-, x, х, X, Х, *) → ×
    # ВАЖНО: используем lookahead (?=\d) чтобы не потреблять второе число
    # Иначе "20x20x20" → "20×20x20" (второй x не заменится)
    prev = None
    while prev != result:
        prev = result
        result = re.sub(r'(\d+)\s*[-xхXХ*]\s*(?=\d)', r'\1×', result)
    # Равносторонние тройники: 20×20×20 → 20 (каталог: "Тройник 20")
    # Проверяем только если это тройник и все три размера одинаковы
    tee_match = re.search(r'\b(\d{2,3})×\1×\1\b', result)
    if tee_match and 'тройник' in result:
        result = re.sub(r'\b(\d{2,3})×\1×\1\b', r'\1', result)
    # Равносторонние отводы/муфты: 20×20 → 20 (каталог: "Отвод 20", "Муфта 20")
    # НО только для ПНД! Канализация имеет "Отвод 110/50" (переход)
    if any(x in result for x in ['пнд', 'компрес', 'комп ']):
        result = re.sub(r'\b(\d{2,3})×\1\b', r'\1', result)
    # Убираем "присоединительный" и "соединительный" - не используется в каталоге
    result = re.sub(r'\bприсоедин\w*\b', '', result)
    # Убираем Jk/Jakko - весь каталог Jakko, не нужно для сравнения
    # НО оставляем Prestige - это линейка малошумной канализации!
    result = re.sub(r'\bjk\b', '', result)
    result = re.sub(r'\bjakko\b', '', result)
    # Убираем префиксы клиента СТ: "СТкв", "СТкн", "СТ ПП"
    result = re.sub(r'\bсткв\b', '', result)  # СТ канализация внутренняя
    result = re.sub(r'\bсткн\b', '', result)  # СТ канализация наружная
    result = re.sub(r'\bст\s+пп\b', '', result)  # СТ полипропилен
    # Унифицируем: малошумн* → prestige (для matching)
    result = re.sub(r'\bмалошумн\w*\b', 'prestige', result)
    # Нормализуем PN (давление): PN 10, PN-10, PN10 → pn10
    result = re.sub(r'\bpn\s*[-]?\s*(\d+)', r'pn\1', result)
    # Убираем лишние пробелы
    result = ' '.join(result.split())
    # Убираем знаки препинания кроме пробелов, × и /
    # × нужен для размеров (25×1/2), / нужен для дробей резьбы (1/2, 3/4)
    result = re.sub(r'[^\w\s×/]', ' ', result)
    result = ' '.join(result.split())
    # Для компрессионных фитингов:
    # 1. Убираем "полиэтилен" (каталог: "Тройник компрессионный 20")
    # 2. Дедупликация "компрессионный компрессионный" → "компрессионный"
    if 'компрессионн' in result:
        result = re.sub(r'\bполиэтилен\b', '', result)
        result = re.sub(r'\bкомпрессионн\w*\s+компрессионн\w*\b', 'компрессионный', result)
        result = ' '.join(result.split())
    return result

def extract_numeric_sku(sku: str) -> str:
    """Извлекает только цифры из артикула"""
    if not sku:
        return ""
    digits = re.sub(r'\D', '', sku)
    return digits.lstrip('0') or '0'

def tokenize_name(name: str) -> set[str]:
    """Разбивает название на токены для сравнения"""
    normalized = normalize_name(name)
    # Убираем стоп-слова
    stop_words = {'для', 'и', 'или', 'с', 'на', 'по', 'из', 'к', 'в', 'от', 'до', 'шт', 'мм', 'см', 'м', 'кг', 'г', 'л', 'мл'}
    tokens = set(normalized.split())
    return tokens - stop_words


def extract_pipe_size(name: str) -> tuple[int, int] | None:
    """
    Извлекает размеры трубы (диаметр×длина) из названия.
    Возвращает (diameter, length) или None если не найдено.

    Примеры:
        "Труба ПП 110×2000" → (110, 2000)
        "Труба 50x1500" → (50, 1500)
        "Труба 32-500" → (32, 500)
        "труба d40 L250мм" → (40, 250)
    """
    if not name:
        return None

    # Паттерн 1: стандартный формат "110×2000", "50x1500", "32-500"
    m = re.search(r'(\d+)\s*[×xхXХ*\-]\s*(\d+)', name)
    if m:
        diameter = int(m.group(1))
        length = int(m.group(2))
        if 16 <= diameter <= 400 and 100 <= length <= 6000:
            return (diameter, length)

    # Паттерн 2: формат СТ "d40 L250мм" или "d50 (1,8) L150мм"
    m = re.search(r'd(\d+).*?L(\d+)', name, re.IGNORECASE)
    if m:
        diameter = int(m.group(1))
        length = int(m.group(2))
        if 16 <= diameter <= 400 and 100 <= length <= 6000:
            return (diameter, length)

    return None


def extract_thread_size(name: str) -> tuple[int, str] | None:
    """
    Извлечь размер с резьбой: "32*1" → (32, "1"), "25x3/4" → (25, "3/4")

    Форматы клиентов:
    - "НР 32*1" = 32мм × 1" (наружная резьба)
    - "ВР 25*3/4" = 25мм × 3/4"
    - "Муфта ППР 25x1" = 25мм × 1" (без явного указания НР/ВР)
    - "32x1" или "32×1" = то же самое

    ВАЖНО: Резьба это дюймы (1/2, 3/4, 1, 1 1/4, 1 1/2, 2),
    а НЕ размеры фитингов (20, 25, 32, 40, 50)!
    Отличаем по значению: дюймы ≤ 2, размеры фитингов ≥ 20

    Возвращает (мм, дюймы) или None
    """
    if not name:
        return None

    # Паттерн: число 20-63 * дюймы
    # Дюймы резьбы: 1/2, 3/4, 1, 1 1/4, 1 1/2, 2 (не 20, 25, 32, 40!)
    # Паттерн: мм * (дробь ИЛИ маленькое число 1-2)
    m = re.search(r'\b(\d{2})\s*[*xх×]\s*(\d/\d|\d\s+\d/\d|\d)\b', name)
    if m:
        mm = int(m.group(1))
        inches = m.group(2).replace(' ', '')
        # Валидация размера мм (20-63) и дюймов резьбы
        if 20 <= mm <= 63:
            # Проверяем что это действительно дюймы резьбы
            # 1, 1/2, 3/4, 1/4, 1 1/4, 1 1/2, 2 - корректные дюймы
            # После replace(' ', '') становятся: 11/4, 11/2, 21/4, 21/2
            # 20, 25, 32, 40 - это размеры фитингов, НЕ резьба!
            valid_threads = ['1', '2', '1/2', '3/4', '1/4', '11/4', '11/2', '21/4', '21/2']
            if inches in valid_threads:
                return (mm, inches)
    return None


def extract_fitting_size(name: str) -> tuple[int, ...] | None:
    """
    Извлекает размеры фитинга из названия (игнорируя углы и резьбу).
    Может быть 1-3 размера: диаметр, или диаметр×диаметр (переход/тройник).

    Примеры:
        "Муфта ППР 32" → (32,)
        "Переход 50×32" → (50, 32)
        "Тройник 110/50" → (110, 50)
        "Муфта компрес. с вн. рез. 25x3/4" → (25,) НЕ (25, 3)!
        "Муфта 32x1" → (32,) НЕ (32, 1)!
    """
    if not name:
        return None

    # Хомуты НЕ являются фитингами - для них используется filter_by_clamp_size
    if 'хомут' in name.lower():
        return None

    # ВАЖНО: Сначала убираем резьбу (×3/4, ×1/2, ×1", x1 1/4)
    # Иначе "25×3/4" парсится как (25, 3) вместо (25,)
    clean_name = name
    # Убираем дюймовую резьбу: ×3/4, x1/2, *1", ×1 1/4"
    clean_name = re.sub(r'[×xхXХ*]\s*\d\s*\d/\d["\']?', ' ', clean_name)  # ×1 1/4"
    clean_name = re.sub(r'[×xхXХ*]\s*\d/\d["\']?', ' ', clean_name)  # ×3/4, ×1/2
    clean_name = re.sub(r'[×xхXХ*]\s*\d["\']', ' ', clean_name)  # ×1", ×2"
    # Убираем размер резьбы без разделителя в конце: "32x1" → "32"
    clean_name = re.sub(r'([×xхXХ*])\s*([12])\b(?![/\d])', ' ', clean_name)

    # Убираем угол с градусами чтобы не путать с размером
    # 45°, 67°, 87°, 90° - это углы, не размеры
    # Форматы: "90°", "90 град", "90 градус", "90 гр."
    clean_name = re.sub(r'\b(45|67|87|90)\s*(?:°|град(?:ус)?\.?|гр\.?)(?:\s|$|(?=[^\d]))', ' ', clean_name, flags=re.IGNORECASE)

    # Для ОТВОДОВ: "110/45", "110/87" - второе число 45/67/87/90 это угол, не размер
    # Убираем /угол (без °) только для отводов
    name_lower = name.lower()
    if any(x in name_lower for x in ['отвод', 'угол', 'колено', 'elbow']):
        clean_name = re.sub(r'[-/×xхXХ]\s*(45|67|87|90)\b', ' ', clean_name)

    # Ищем размеры фитингов в формате: 110-50, 110/50, 110×50, 110x50
    # Паттерн: большое_число разделитель маленькое_число (опционально третий)
    m = re.search(r'\b(\d{2,3})\s*[-/×xхXХ*]\s*(\d{2,3})(?:\s*[-/×xхXХ*]\s*(\d{2,3}))?\b', clean_name)
    if m:
        sizes = [int(s) for s in m.groups() if s]
        # Валидация: размеры фитингов 20-200мм (ППР от 20мм, канализация 32-160)
        if all(20 <= s <= 200 for s in sizes):
            return tuple(sizes)

    # Одиночный размер (Муфта 32, Заглушка 110, Сифон 50)
    # Ищем число 20-200 в любом месте названия после типа товара
    name_lower = clean_name.lower()
    types_pattern = r'(муфт|заглуш|ревизи|крестовин|тройник|переход|отвод|угол|сифон|клипс)'
    if re.search(types_pattern, name_lower):
        # Ищем все числа 20-200 в названии
        # Паттерны: "110", "110мм", "d50мм", "d110"
        numbers = [int(n) for n in re.findall(r'(?:\b|d)(\d{2,3})(?:мм)?\b', name_lower) if 20 <= int(n) <= 200]
        if numbers:
            return (numbers[0],)  # Берём первое подходящее число

    return None


def is_coupling_detachable(name: str) -> bool:
    """
    Определяет, является ли муфта разъемной (американкой).

    Разъемные муфты:
    - "Муфта разъемная ППР ЭКО с вн. рез. белый 32x1" Jakko"
    - "Муфта американка 25x3/4 НР"
    - "Муфта комбинированная разъемная 20x1/2 ВР"

    Обычные муфты (НЕ разъемные):
    - "Муфта ППР белый 32 Jakko"
    - "Муфта переходник ППР 50-32"
    """
    if not name:
        return False

    name_lower = name.lower()

    # Признаки разъемной муфты
    detachable_keywords = [
        'разъемн',      # разъемная/разъемный
        'американ',     # американка
        'комбинирован', # комбинированная (с резьбой)
    ]

    return any(kw in name_lower for kw in detachable_keywords)


def is_reducer(name: str) -> bool:
    """
    Определяет, является ли товар переходником (разные диаметры).

    Переходники:
    - "Муфта переходная 50x32"
    - "Тройник переходной 32х20х32"
    - "Переход 110-50"
    - "Тройник ред. 40*25*40"

    Обычные (НЕ переходники):
    - "Муфта ППР 32"
    - "Тройник 110"
    """
    if not name:
        return False

    name_lower = name.lower()

    # Признаки переходника
    reducer_keywords = [
        'переход',  # переход/переходник/переходной/переходная
        'ред.',     # сокращение "ред."
        'ред ',     # сокращение "ред "
    ]

    return any(kw in name_lower for kw in reducer_keywords)
